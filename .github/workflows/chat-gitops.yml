name: Chat Services GitOps Pipeline

on:
  push:
    branches: [ main, develop, 'feature/*', 'hotfix/*', 'release/*' ]
    paths:
      - 'microservices/**/domain.yml'
      - 'microservices/**/config.yml'
      - 'microservices/**/data/**'
      - 'microservices/**/actions/**'
      - 'microservices/**/docker/Dockerfile'
      - 'microservices/**/docker/rasa/Dockerfile'
      - 'microservices/**/docker/rasa-actions/Dockerfile'
      - 'microservices/**/pyproject.toml'
      - 'microservices/**/credentials.yml'
      - 'microservices/**/endpoints.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'microservices/**/domain.yml'
      - 'microservices/**/config.yml'
      - 'microservices/**/data/**'
      - 'microservices/**/actions/**'
      - 'microservices/**/docker/Dockerfile'
      - 'microservices/**/docker/rasa/Dockerfile'
      - 'microservices/**/docker/rasa-actions/Dockerfile'

permissions:
  contents: read
  actions: read
  security-events: write
  packages: write

env:
  # Docker Hub settings (default)
  DOCKERHUB_REGISTRY: docker.io  # Legacy - use DOCKERHUB_REGISTRY
  DOCKERHUB_USERNAME: socrates12345
  # ACR settings
  ACR_REGISTRY: healthidpuaeacr.azurecr.io
  ACR_NAME: healthidpuaeacr
  # Default registry selection
  DEFAULT_REGISTRY: dockerhub  # or "acr" or "both"
  # Legacy variables for backward compatibility
  REGISTRY: docker.io  # Legacy - use DOCKERHUB_REGISTRY
  REGISTRY_USERNAME: socrates12345  # Legacy - use DOCKERHUB_USERNAME
  GITOPS_REPO: health-service-idp-gitops
  GITOPS_BRANCH: main

jobs:
  # Phase 1: Detect Chat Services
  detect-chat-services:
    runs-on: ubuntu-latest
    outputs:
      changed-services: ${{ steps.changes.outputs.changed-services }}
      changed-services-json: ${{ steps.changes.outputs.changed-services-json }}
      should-deploy: ${{ steps.changes.outputs.should-deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed chat services
        id: changes
        run: |
          # Get list of changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Find chat services (directories with domain.yml and config.yml)
          CHAT_SERVICES=""
          CHAT_SERVICES_JSON="[]"
          
          # Get all microservice directories that have changed
          CHANGED_DIRS=$(echo "$CHANGED_FILES" | grep '^microservices/' | cut -d'/' -f1-2 | sort -u | cut -d'/' -f2)
          
          if [ ! -z "$CHANGED_DIRS" ]; then
            for service in $CHANGED_DIRS; do
              # Check if this service has chat indicators (domain.yml and config.yml)
              if [ -f "microservices/$service/domain.yml" ] && [ -f "microservices/$service/config.yml" ]; then
                echo "ü§ñ Detected chat service: $service"
                if [ -z "$CHAT_SERVICES" ]; then
                  CHAT_SERVICES="$service"
                else
                  CHAT_SERVICES="$CHAT_SERVICES,$service"
                fi
              fi
            done
            
            # Create JSON array for matrix
            if [ ! -z "$CHAT_SERVICES" ]; then
              CHAT_SERVICES_JSON="["
              FIRST=true
              IFS=',' read -ra SERVICE_ARRAY <<< "$CHAT_SERVICES"
              for service in "${SERVICE_ARRAY[@]}"; do
                if [ "$FIRST" = true ]; then
                  CHAT_SERVICES_JSON="$CHAT_SERVICES_JSON\"$service\""
                  FIRST=false
                else
                  CHAT_SERVICES_JSON="$CHAT_SERVICES_JSON,\"$service\""
                fi
              done
              CHAT_SERVICES_JSON="$CHAT_SERVICES_JSON]"
            fi
          fi
          
          # Determine if we should deploy (only on main branch pushes)
          SHOULD_DEPLOY="false"
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            SHOULD_DEPLOY="true"
          fi
          
          echo "changed-services=$CHAT_SERVICES" >> $GITHUB_OUTPUT
          echo "changed-services-json=$CHAT_SERVICES_JSON" >> $GITHUB_OUTPUT
          echo "should-deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "Chat services found: $CHAT_SERVICES"
          echo "Chat services JSON: $CHAT_SERVICES_JSON"
          echo "Should deploy: $SHOULD_DEPLOY"

  # Phase 2: Security Scanning for Chat Services
  chat-vulnerability-scan:
    needs: detect-chat-services
    if: needs.detect-chat-services.outputs.changed-services != '' && fromJson(needs.detect-chat-services.outputs.changed-services-json)[0] != null
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-chat-services.outputs.changed-services-json) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check service structure
        run: |
          echo "üîç Checking Docker structure for ${{ matrix.service }}..."
          ls -la "microservices/${{ matrix.service }}"
          if [ -d "microservices/${{ matrix.service }}/docker" ]; then
            echo "üìÅ Docker directory structure:"
            ls -la "microservices/${{ matrix.service }}/docker/"
          fi

      - name: Build Base image for scanning
        run: |
          echo "üîç Building Base image for ${{ matrix.service }} security scanning..."
          
          # Check if base Dockerfile exists
          if [ -f "microservices/${{ matrix.service }}/docker/Dockerfile" ]; then
            echo "üì¶ Building base image from docker/Dockerfile"
            docker build -t local-scan/${{ matrix.service }}-base:latest \
              -f "microservices/${{ matrix.service }}/docker/Dockerfile" \
              "microservices/${{ matrix.service }}"
          else
            echo "‚ùå No base Dockerfile found at microservices/${{ matrix.service }}/docker/Dockerfile"
            echo "Available files:"
            find "microservices/${{ matrix.service }}" -name "*Dockerfile*" -type f || true
            exit 1
          fi

      - name: Build Rasa image for scanning
        run: |
          echo "üîç Building Rasa container for ${{ matrix.service }} security scanning..."
          
          if [ -f "microservices/${{ matrix.service }}/docker/rasa/Dockerfile" ]; then
            echo "üì¶ Building Rasa image from docker/rasa/Dockerfile"
            docker build -t local-scan/${{ matrix.service }}-rasa:latest \
              --build-arg BASE_IMAGE=local-scan/${{ matrix.service }}-base:latest \
              -f "microservices/${{ matrix.service }}/docker/rasa/Dockerfile" \
              "microservices/${{ matrix.service }}"
          else
            echo "‚ö†Ô∏è No Rasa Dockerfile found, skipping Rasa scan"
          fi

      - name: Build Actions image for scanning
        run: |
          echo "üîç Building Actions container for ${{ matrix.service }} security scanning..."
          
          if [ -f "microservices/${{ matrix.service }}/docker/rasa-actions/Dockerfile" ]; then
            echo "üì¶ Building Actions image from docker/rasa-actions/Dockerfile"
            docker build -t local-scan/${{ matrix.service }}-actions:latest \
              --build-arg BASE_IMAGE=local-scan/${{ matrix.service }}-base:latest \
              -f "microservices/${{ matrix.service }}/docker/rasa-actions/Dockerfile" \
              "microservices/${{ matrix.service }}"
          else
            echo "‚ö†Ô∏è No Actions Dockerfile found, skipping Actions scan"
          fi

      - name: Run Trivy on Base image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'local-scan/${{ matrix.service }}-base:latest'
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}-base.sarif'
        continue-on-error: true

      - name: Run Trivy on Rasa container
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'local-scan/${{ matrix.service }}-rasa:latest'
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}-rasa.sarif'
        continue-on-error: true
        if: success() || failure()  # Run even if base scan failed

      - name: Run Trivy on Actions container
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'local-scan/${{ matrix.service }}-actions:latest'
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}-actions.sarif'
        continue-on-error: true
        if: success() || failure()  # Run even if previous scans failed

      - name: Upload Base scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}-base.sarif'
          category: 'trivy-${{ matrix.service }}-base'
        continue-on-error: true

      - name: Upload Rasa scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}-rasa.sarif'
          category: 'trivy-${{ matrix.service }}-rasa'
        continue-on-error: true

      - name: Upload Actions scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}-actions.sarif'
          category: 'trivy-${{ matrix.service }}-actions'
        continue-on-error: true

  # Phase 2.5: Code Quality Analysis (GitHub CodeQL + Linters)
  code-quality-analysis:
    needs: detect-chat-services
    if: needs.detect-chat-services.outputs.changed-services != '' && fromJson(needs.detect-chat-services.outputs.changed-services-json)[0] != null
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't block GitOps pipeline on quality issues
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-chat-services.outputs.changed-services-json) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Initialize GitHub CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-extended,quality

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies for analysis
        run: |
          echo "üîç Installing dependencies for ${{ matrix.service }} analysis..."
          
          if [ -f "microservices/${{ matrix.service }}/pyproject.toml" ]; then
            echo "üì¶ Found pyproject.toml, installing with pip"
            cd "microservices/${{ matrix.service }}"
            
            # Install poetry if pyproject.toml uses poetry
            if grep -q "tool.poetry" pyproject.toml; then
              pip install poetry
              poetry config virtualenvs.create false
              poetry install --no-root || echo "‚ö†Ô∏è Poetry install failed, continuing with pip"
            else
              pip install -e . || echo "‚ö†Ô∏è pip install failed, continuing with analysis"
            fi
          elif [ -f "microservices/${{ matrix.service }}/requirements.txt" ]; then
            echo "üì¶ Found requirements.txt, installing with pip"
            pip install -r "microservices/${{ matrix.service }}/requirements.txt" || echo "‚ö†Ô∏è Requirements install failed, continuing with analysis"
          else
            echo "‚ö†Ô∏è No dependency file found, running analysis without dependencies"
          fi

      - name: Run Python linting with Bandit (Security)
        run: |
          echo "üîí Running Bandit security analysis for ${{ matrix.service }}..."
          pip install bandit[toml]
          cd "microservices/${{ matrix.service }}"
          
          # Create bandit config if it doesn't exist
          if [ ! -f "pyproject.toml" ] || ! grep -q "\[tool.bandit\]" pyproject.toml; then
            echo "Creating basic bandit configuration..."
            cat >> .bandit << EOF
[bandit]
exclude_dirs = ["tests", "test_*", "__pycache__", "venv", "env"]
skips = ["B101"]  # Skip assert_used test
EOF
          fi
          
          bandit -r . -f json -o bandit-report.json || echo "‚ö†Ô∏è Bandit found security issues"
          bandit -r . -f txt || echo "‚ö†Ô∏è Bandit security scan completed with warnings"

      - name: Run Python linting with flake8 (Style & Quality)
        run: |
          echo "üìã Running flake8 code quality analysis for ${{ matrix.service }}..."
          pip install flake8 flake8-docstrings flake8-import-order
          cd "microservices/${{ matrix.service }}"
          
          # Create flake8 config if it doesn't exist
          if [ ! -f ".flake8" ] && [ ! -f "setup.cfg" ]; then
            cat > .flake8 << EOF
[flake8]
max-line-length = 100
ignore = E203, W503, D100, D101, D102, D103, D104, D105
exclude = __pycache__, venv, env, tests, .git
max-complexity = 10
EOF
          fi
          
          flake8 . --statistics --tee --output-file=flake8-report.txt || echo "‚ö†Ô∏è flake8 found style issues"

      - name: Run tests with coverage
        run: |
          echo "üß™ Running tests with coverage for ${{ matrix.service }}..."
          cd "microservices/${{ matrix.service }}"
          
          # Install coverage tools
          pip install pytest pytest-cov coverage || echo "‚ö†Ô∏è Failed to install test tools"
          
          # Run tests with coverage if pytest is available
          if command -v pytest &> /dev/null; then
            if [ -d "tests" ] || find . -name "test_*.py" | grep -q .; then
              echo "Running pytest with coverage..."
              pytest --cov=. --cov-report=xml --cov-report=term-missing --junitxml=pytest-report.xml || echo "‚ö†Ô∏è Tests failed or no tests found"
            else
              echo "‚ö†Ô∏è No tests found, creating empty coverage report"
              coverage run --source=. -m pytest || true
              coverage xml || true
            fi
          else
            echo "‚ö†Ô∏è pytest not available, skipping test coverage"
            echo '<?xml version="1.0" encoding="UTF-8"?><coverage></coverage>' > coverage.xml
          fi

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: ${{ matrix.service }}
          path: microservices/${{ matrix.service }}
          format: SARIF
          out: dependency-check-report.sarif
        continue-on-error: true

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "codeql-${{ matrix.service }}"
        continue-on-error: true

      - name: Upload Bandit results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: microservices/${{ matrix.service }}/bandit-report.json
          category: "bandit-${{ matrix.service }}"
        continue-on-error: true

      - name: Upload OWASP Dependency Check results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: dependency-check-report.sarif
          category: "dependency-check-${{ matrix.service }}"
        continue-on-error: true

      - name: Generate Code Quality Summary
        if: always()
        run: |
          echo "## üîç Code Quality Analysis Results for ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cd "microservices/${{ matrix.service }}"
          
          # Bandit Security Summary
          if [ -f "bandit-report.json" ]; then
            BANDIT_ISSUES=$(jq '.metrics._totals.loc' bandit-report.json 2>/dev/null || echo "N/A")
            echo "### üîí Security Analysis (Bandit)" >> $GITHUB_STEP_SUMMARY
            echo "- **Lines Analyzed**: $BANDIT_ISSUES" >> $GITHUB_STEP_SUMMARY
            if [ -f "bandit-report.json" ]; then
              HIGH_ISSUES=$(jq '[.results[] | select(.issue_severity=="HIGH")] | length' bandit-report.json 2>/dev/null || echo "0")
              MED_ISSUES=$(jq '[.results[] | select(.issue_severity=="MEDIUM")] | length' bandit-report.json 2>/dev/null || echo "0")
              echo "- **High Severity Issues**: $HIGH_ISSUES" >> $GITHUB_STEP_SUMMARY
              echo "- **Medium Severity Issues**: $MED_ISSUES" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Flake8 Quality Summary
          if [ -f "flake8-report.txt" ]; then
            echo "### üìã Code Quality (flake8)" >> $GITHUB_STEP_SUMMARY
            TOTAL_ISSUES=$(wc -l < flake8-report.txt || echo "0")
            echo "- **Total Style Issues**: $TOTAL_ISSUES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Test Coverage Summary
          if [ -f "coverage.xml" ]; then
            echo "### üß™ Test Coverage" >> $GITHUB_STEP_SUMMARY
            COVERAGE=$(grep -o 'line-rate="[^"]*"' coverage.xml | head -1 | grep -o '[0-9.]*' | awk '{print int($1*100)}' || echo "N/A")
            echo "- **Line Coverage**: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### ‚úÖ Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "All results have been uploaded to GitHub Security tab for detailed review." >> $GITHUB_STEP_SUMMARY

  # Phase 3: Build and Push Chat Containers
  build-chat-containers:
    needs: [detect-chat-services, chat-vulnerability-scan, code-quality-analysis]
    if: always() && needs.detect-chat-services.outputs.changed-services != '' && needs.detect-chat-services.outputs.should-deploy == 'true' && (needs.chat-vulnerability-scan.result == 'success' || needs.chat-vulnerability-scan.result == 'failure') && (needs.code-quality-analysis.result == 'success' || needs.code-quality-analysis.result == 'failure')
    runs-on: ubuntu-latest
    outputs:
      version-info: ${{ steps.versions.outputs.version-info }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.REGISTRY_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push chat containers
        id: versions
        run: |
          chmod +x .github/scripts/version-manager.sh
          
          IFS=',' read -ra SERVICES <<< "${{ needs.detect-chat-services.outputs.changed-services }}"
          VERSION_INFO=""
          
          for service in "${SERVICES[@]}"; do
            echo "ü§ñ Building chat service containers for: $service"
            
            # Generate semantic version
            SEMVER=$(.github/scripts/version-manager.sh version "$service")
            COMMIT_SHA="${GITHUB_SHA:0:7}"
            
            echo "üè∑Ô∏è Chat Service: $service"
            echo "üì¶ Semantic Version: $SEMVER"
            
            SERVICE_BASE="${service%-*}"  # Remove -anthropic or -deterministic suffix if present
            if [ "$SERVICE_BASE" = "$service" ]; then
              SERVICE_BASE="$service"  # No suffix to remove
            fi
            
            # Build Base image first
            BASE_IMAGE="${{ env.REGISTRY }}/${{ env.REGISTRY_USERNAME }}/${SERVICE_BASE}-base"
            BASE_TAG="$BASE_IMAGE:$COMMIT_SHA"
            BASE_LATEST="$BASE_IMAGE:latest"
            BASE_VERSION="$BASE_IMAGE:$SEMVER"
            
            echo "üèóÔ∏è Building Base image: $BASE_TAG"
            docker build -t "$BASE_TAG" \
              -f "microservices/$service/docker/Dockerfile" \
              --build-arg BUILD_VERSION="$SEMVER" \
              --build-arg BUILD_COMMIT="$COMMIT_SHA" \
              --build-arg BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              --label "org.opencontainers.image.version=$SEMVER" \
              --label "org.opencontainers.image.revision=${{ github.sha }}" \
              --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
              --label "org.opencontainers.image.created=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              --label "org.opencontainers.image.title=${SERVICE_BASE}-base" \
              --label "org.opencontainers.image.description=Base Image for Rasa Chatbot - $service" \
              "microservices/$service"
            
            # Tag and push Base image
            docker tag "$BASE_TAG" "$BASE_LATEST"
            docker tag "$BASE_TAG" "$BASE_VERSION"
            echo "üì§ Pushing Base image tags..."
            docker push "$BASE_TAG"
            docker push "$BASE_LATEST"
            docker push "$BASE_VERSION"
            
            # Build Rasa container with base image reference
            RASA_IMAGE="${{ env.REGISTRY }}/${{ env.REGISTRY_USERNAME }}/${SERVICE_BASE}-rasa"
            RASA_TAG="$RASA_IMAGE:$COMMIT_SHA"
            RASA_LATEST="$RASA_IMAGE:latest"
            RASA_VERSION="$RASA_IMAGE:$SEMVER"
            
            echo "üèóÔ∏è Building Rasa container: $RASA_TAG"
            docker build -t "$RASA_TAG" \
              --build-arg BASE_IMAGE="$BASE_TAG" \
              -f "microservices/$service/docker/rasa/Dockerfile" \
              --build-arg BUILD_VERSION="$SEMVER" \
              --build-arg BUILD_COMMIT="$COMMIT_SHA" \
              --build-arg BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              --label "org.opencontainers.image.version=$SEMVER" \
              --label "org.opencontainers.image.revision=${{ github.sha }}" \
              --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
              --label "org.opencontainers.image.created=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              --label "org.opencontainers.image.title=${SERVICE_BASE}-rasa" \
              --label "org.opencontainers.image.description=Rasa Chatbot Server - $service" \
              --label "version=$SEMVER" \
              --label "commit=${{ github.sha }}" \
              --label "commit-short=$COMMIT_SHA" \
              --label "branch=${{ github.ref_name }}" \
              --label "service=${SERVICE_BASE}-rasa" \
              --label "service-type=chat" \
              --label "component=rasa-server" \
              --label "build-date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              --label "build-number=${{ github.run_number }}" \
              --label "workflow-run=${{ github.run_id }}" \
              "microservices/$service"
            
            # Tag and push Rasa container
            docker tag "$RASA_TAG" "$RASA_LATEST"
            docker tag "$RASA_TAG" "$RASA_VERSION"
            echo "üì§ Pushing Rasa container tags..."
            docker push "$RASA_TAG"
            docker push "$RASA_LATEST"
            docker push "$RASA_VERSION"
            
            # Build Actions container with base image reference
            ACTIONS_IMAGE="${{ env.REGISTRY }}/${{ env.REGISTRY_USERNAME }}/${SERVICE_BASE}-actions"
            ACTIONS_TAG="$ACTIONS_IMAGE:$COMMIT_SHA"
            ACTIONS_LATEST="$ACTIONS_IMAGE:latest"
            ACTIONS_VERSION="$ACTIONS_IMAGE:$SEMVER"
            
            echo "üèóÔ∏è Building Actions container: $ACTIONS_TAG"
            docker build -t "$ACTIONS_TAG" \
              --build-arg BASE_IMAGE="$BASE_TAG" \
              -f "microservices/$service/docker/rasa-actions/Dockerfile" \
              --build-arg BUILD_VERSION="$SEMVER" \
              --build-arg BUILD_COMMIT="$COMMIT_SHA" \
              --build-arg BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              --label "org.opencontainers.image.version=$SEMVER" \
              --label "org.opencontainers.image.revision=${{ github.sha }}" \
              --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
              --label "org.opencontainers.image.created=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              --label "org.opencontainers.image.title=${SERVICE_BASE}-actions" \
              --label "org.opencontainers.image.description=Rasa Actions Server - $service" \
              --label "version=$SEMVER" \
              --label "commit=${{ github.sha }}" \
              --label "commit-short=$COMMIT_SHA" \
              --label "branch=${{ github.ref_name }}" \
              --label "service=${SERVICE_BASE}-actions" \
              --label "service-type=chat" \
              --label "component=actions-server" \
              --label "build-date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              --label "build-number=${{ github.run_number }}" \
              --label "workflow-run=${{ github.run_id }}" \
              "microservices/$service"
            
            # Tag and push Actions container
            docker tag "$ACTIONS_TAG" "$ACTIONS_LATEST"
            docker tag "$ACTIONS_TAG" "$ACTIONS_VERSION"
            echo "üì§ Pushing Actions container tags..."
            docker push "$ACTIONS_TAG"
            docker push "$ACTIONS_LATEST"
            docker push "$ACTIONS_VERSION"
            
            echo "‚úÖ Successfully built and pushed chat service containers:"
            echo "   Base: $BASE_TAG, $BASE_LATEST, $BASE_VERSION"
            echo "   Rasa: $RASA_TAG, $RASA_LATEST, $RASA_VERSION"
            echo "   Actions: $ACTIONS_TAG, $ACTIONS_LATEST, $ACTIONS_VERSION"
            
            # Store version info
            VERSION_INFO="$VERSION_INFO$service:$SEMVER,"
          done
          
          echo "version-info=${VERSION_INFO%,}" >> $GITHUB_OUTPUT

  # Phase 4: GitOps Update for Chat Services
  trigger-chat-gitops-update:
    needs: [detect-chat-services, build-chat-containers]
    if: needs.detect-chat-services.outputs.changed-services != '' && needs.detect-chat-services.outputs.should-deploy == 'true' && needs.build-chat-containers.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger GitOps repository update for chat services
        run: |
          echo "üöÄ Triggering GitOps repository update for chat services..."
          
          SERVICES="${{ needs.detect-chat-services.outputs.changed-services }}"
          VERSION_INFO="${{ needs.build-chat-containers.outputs.version-info }}"
          SOURCE_COMMIT="${{ github.sha }}"
          COMMIT_SHA="${GITHUB_SHA:0:7}"
          
          echo "Chat services to update: $SERVICES"
          echo "Version info: $VERSION_INFO"
          echo "Source commit: $SOURCE_COMMIT"
          
          # Create payload for each chat service
          IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
          
          DEPLOYMENTS=""
          for service in "${SERVICE_ARRAY[@]}"; do
            SERVICE_BASE="${service%-*}"  # Remove -anthropic or -deterministic suffix if present
            if [ "$SERVICE_BASE" = "$service" ]; then
              SERVICE_BASE="$service"  # No suffix to remove
            fi
            
            RASA_IMAGE="${{ env.REGISTRY }}/${{ env.REGISTRY_USERNAME }}/${SERVICE_BASE}-rasa:$COMMIT_SHA"
            ACTIONS_IMAGE="${{ env.REGISTRY }}/${{ env.REGISTRY_USERNAME }}/${SERVICE_BASE}-actions:$COMMIT_SHA"
            
            if [ -z "$DEPLOYMENTS" ]; then
              DEPLOYMENTS="\"$service\": {\"rasa_image\": \"$RASA_IMAGE\", \"actions_image\": \"$ACTIONS_IMAGE\", \"commit\": \"$COMMIT_SHA\", \"type\": \"chat\"}"
            else
              DEPLOYMENTS="$DEPLOYMENTS, \"$service\": {\"rasa_image\": \"$RASA_IMAGE\", \"actions_image\": \"$ACTIONS_IMAGE\", \"commit\": \"$COMMIT_SHA\", \"type\": \"chat\"}"
            fi
          done
          
          echo "Chat deployments payload: {$DEPLOYMENTS}"
          
          # Set up GitHub CLI authentication
          export GH_TOKEN="${{ secrets.PERSONAL_ACCESS_TOKEN }}"
          
          echo "üì§ Sending chat services dispatch event using GitHub CLI..."
          
          # Trigger repository dispatch for chat services
          if gh api repos/shlapolosa/${{ env.GITOPS_REPO }}/dispatches \
            --method POST \
            --field event_type=update-chat-deployments \
            --field client_payload[services]="$SERVICES" \
            --field client_payload[version_info]="$VERSION_INFO" \
            --field client_payload[source_commit]="$SOURCE_COMMIT" \
            --field client_payload[registry]="${{ env.REGISTRY }}/${{ env.REGISTRY_USERNAME }}" \
            --field client_payload[branch]="${{ github.ref_name }}" \
            --field client_payload[workflow_run]="${{ github.run_id }}" \
            --raw-field client_payload[deployments]="{$DEPLOYMENTS}"; then
            echo "‚úÖ Chat services GitOps repository dispatch event sent successfully!"
            echo "üîó GitOps repository will handle the chat service manifest updates"
          else
            echo "‚ùå Failed to send chat services dispatch event"
            echo "Manual GitOps update required for chat services:"
            echo "  Services: $SERVICES"
            echo "  Rasa Images: ${{ env.REGISTRY }}/${{ env.REGISTRY_USERNAME }}/SERVICE_BASE-rasa:$COMMIT_SHA"
            echo "  Actions Images: ${{ env.REGISTRY }}/${{ env.REGISTRY_USERNAME }}/SERVICE_BASE-actions:$COMMIT_SHA"
            exit 1
          fi

  # Phase 5: Generate Summary
  chat-deployment-summary:
    needs: [detect-chat-services, chat-vulnerability-scan, code-quality-analysis, build-chat-containers, trigger-chat-gitops-update]
    if: always() && needs.detect-chat-services.outputs.changed-services != ''
    runs-on: ubuntu-latest
    steps:
      - name: Generate chat deployment summary
        run: |
          echo "## ü§ñ Chat Services GitOps Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîç Security & Quality Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- **Chat Vulnerability Scan**: ${{ needs.chat-vulnerability-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Quality Analysis**: ${{ needs.code-quality-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üèóÔ∏è Build & Deploy" >> $GITHUB_STEP_SUMMARY
          echo "- **Changed Chat Services**: ${{ needs.detect-chat-services.outputs.changed-services }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Container Building**: ${{ needs.build-chat-containers.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GitOps Update**: ${{ needs.trigger-chat-gitops-update.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Info**: ${{ needs.build-chat-containers.outputs.version-info }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Pipeline Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Source Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: \`${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **GitOps Repo**: [health-service-idp-gitops](https://github.com/shlapolosa/health-service-idp-gitops)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üéØ **Chat Pipeline Status**: Detection ‚Üí Security ‚Üí Quality ‚Üí Build ‚Üí GitOps ‚Üí Complete!"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Built Containers" >> $GITHUB_STEP_SUMMARY
          
          IFS=',' read -ra SERVICES <<< "${{ needs.detect-chat-services.outputs.changed-services }}"
          COMMIT_SHA="${GITHUB_SHA:0:7}"
          
          for service in "${SERVICES[@]}"; do
            SERVICE_BASE="${service%-*}"
            if [ "$SERVICE_BASE" = "$service" ]; then
              SERVICE_BASE="$service"
            fi
            echo "- **$service**:" >> $GITHUB_STEP_SUMMARY
            echo "  - Base: \`socrates12345/${SERVICE_BASE}-base:$COMMIT_SHA\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Rasa: \`socrates12345/${SERVICE_BASE}-rasa:$COMMIT_SHA\`" >> $GITHUB_STEP_SUMMARY
            echo "  - Actions: \`socrates12345/${SERVICE_BASE}-actions:$COMMIT_SHA\`" >> $GITHUB_STEP_SUMMARY
          done
